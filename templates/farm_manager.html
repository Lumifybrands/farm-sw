{% extends "base.html" %}

{% block title %}Farm Manager - Bismi Farms{% endblock %}

{% block content %}
<div class="content-header">
    <h1>Farm Manager</h1>
    <div class="breadcrumb">
        <span>Home</span> / <span>Farm Manager</span>
    </div>
</div>

<div class="manager-container">
    <div class="manager-header">
        <div class="search-bar">
            <input type="text" id="managerSearch" placeholder="Search managers...">
            <i class="fas fa-search"></i>
        </div>
        <button class="add-manager-btn" onclick="openAddModal()">
            <i class="fas fa-plus"></i> Add Manager
        </button>
    </div>

    <div class="manager-table-container">
        <table class="manager-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Username</th>
                    <th>Manager Type</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ user.employee.name if user.employee else 'N/A' }}</td>
                    <td>{{ user.username }}</td>
                    <td>
                        <span class="badge {% if user.user_type == 'senior_manager' %}badge-primary{% else %}badge-secondary{% endif %}">
                            {{ 'Senior Manager' if user.user_type == 'senior_manager' else 'Assistant Manager' }}
                        </span>
                    </td>
                    <td class="action-buttons">
                        <button class="action-btn edit" onclick="editManager('{{ user.id }}', '{{ user.username }}', '{{ user.employee.name if user.employee else '' }}', '{{ user.user_type }}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete" onclick="deleteManager('{{ user.id }}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add Manager Modal -->
<div class="modal" id="addManagerModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Manager</h3>
                <button type="button" class="close" onclick="closeAddModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addManagerForm" action="{{ url_for('add_manager') }}" method="POST">
                    <div class="form-group">
                        <label for="name">Full Name</label>
                        <input type="text" id="name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                    <div class="form-group">
                        <label for="user_type">Manager Type</label>
                        <select id="user_type" name="user_type" required>
                            <option value="assistant_manager">Assistant Manager</option>
                            <option value="senior_manager">Senior Manager</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitAddForm()">Add Manager</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Manager Modal -->
<div class="modal" id="editManagerModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Manager</h3>
                <button type="button" class="close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editManagerForm" method="POST">
                    <div class="form-group">
                        <label for="edit_name">Full Name</label>
                        <input type="text" id="edit_name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="edit_username">Username</label>
                        <input type="text" id="edit_username" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="edit_password">New Password (leave blank to keep current)</label>
                        <input type="password" id="edit_password" name="password">
                    </div>
                    <div class="form-group">
                        <label for="edit_user_type">Manager Type</label>
                        <select id="edit_user_type" name="user_type" required>
                            <option value="assistant_manager">Assistant Manager</option>
                            <option value="senior_manager">Senior Manager</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitEditForm()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<style>
.content-header h1 {
    color: #1a73e8;
}

.manager-container {
    padding: 20px;
}

.manager-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.search-bar {
    position: relative;
    flex: 1;
    max-width: 300px;
}

.search-bar input {
    width: 100%;
    padding: 8px 32px 8px 12px;
    border: 1px solid #1a73e8;
    border-radius: 4px;
    font-size: 14px;
}

.search-bar input:focus {
    outline: none;
    border-color: #1557b0;
    box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
}

.search-bar i {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: #1a73e8;
}

.add-manager-btn {
    background-color: #1a73e8;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
}

.add-manager-btn:hover {
    background-color: #1557b0;
}

.manager-table-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.manager-table {
    width: 100%;
    border-collapse: collapse;
}

.manager-table th {
    background-color: #f8f9fa;
    color: #2c3e50;
    font-weight: 600;
    padding: 12px 16px;
    text-align: left;
    border-bottom: 2px solid #e0e0e0;
}

.manager-table td {
    padding: 12px 16px;
    border-bottom: 1px solid #e0e0e0;
}

.manager-table tr:hover {
    background-color: rgba(26, 115, 232, 0.05);
}

.badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: 500;
    font-size: 12px;
}

.badge-primary {
    background-color: #e8f0fe;
    color: #1a73e8;
}

.badge-secondary {
    background-color: #f1f3f4;
    color: #5f6368;
}

.action-buttons {
    display: flex;
    gap: 8px;
}

.action-btn {
    border: none;
    width: 32px;
    height: 32px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: white;
}

.action-btn.edit {
    background-color: #1a73e8;
}

.action-btn.edit:hover {
    background-color: #1557b0;
}

.action-btn.delete {
    background-color: #dc3545;
}

.action-btn.delete:hover {
    background-color: #c82333;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    z-index: 1000;
}

.modal-dialog {
    margin: 60px auto;
    max-width: 500px;
    background: white;
    border-radius: 8px;
    overflow: hidden;
}

.modal-content {
    position: relative;
}

.modal-header {
    padding: 15px 20px;
    border-bottom: 1px solid #e0e0e0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    padding: 15px 20px;
    border-top: 1px solid #e0e0e0;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.close {
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
    border: none;
    background: none;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #2c3e50;
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.form-group input:focus,
.form-group select:focus {
    border-color: #1a73e8;
    outline: none;
    box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}

.btn-primary {
    background-color: #1a73e8;
    color: white;
}

.btn-primary:hover {
    background-color: #1557b0;
}

.btn-secondary {
    background-color: #5f6368;
    color: white;
}

.btn-secondary:hover {
    background-color: #494d51;
}
</style>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
function openAddModal() {
    document.getElementById('addManagerModal').style.display = 'block';
}

function closeAddModal() {
    document.getElementById('addManagerModal').style.display = 'none';
    document.getElementById('addManagerForm').reset();
}

function submitAddForm() {
    document.getElementById('addManagerForm').submit();
}

function editManager(id, username, name, userType) {
    document.getElementById('editManagerForm').action = `/edit_manager/${id}`;
    document.getElementById('edit_username').value = username;
    document.getElementById('edit_name').value = name;
    document.getElementById('edit_user_type').value = userType;
    document.getElementById('edit_password').value = '';
    document.getElementById('editManagerModal').style.display = 'block';
}

function closeEditModal() {
    document.getElementById('editManagerModal').style.display = 'none';
}

function submitEditForm() {
    document.getElementById('editManagerForm').submit();
}

function deleteManager(id) {
    if (confirm('Are you sure you want to delete this manager?')) {
        fetch(`/delete_manager/${id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'Error deleting manager');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting manager');
        });
    }
}

document.getElementById('managerSearch').addEventListener('input', function(e) {
    const searchText = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('.manager-table tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchText) ? '' : 'none';
    });
});

// Close modals when clicking outside
window.onclick = function(event) {
    const addModal = document.getElementById('addManagerModal');
    const editModal = document.getElementById('editManagerModal');
    if (event.target == addModal) {
        closeAddModal();
    }
    if (event.target == editModal) {
        closeEditModal();
    }
}
</script>
{% endblock %} 