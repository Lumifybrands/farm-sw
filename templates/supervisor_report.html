{% extends "base.html" %}

{% block title %}Supervisor Report{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-header">
                <h1><i class="fas fa-user-check"></i> Supervisor Report</h1>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="card-title">Generate Report</h5>
                            <p class="card-text">Select a date and generate the supervisor report for ongoing and closing batches.</p>
                            <div class="date-filter-section">
                                <label for="reportDate">Select Date:</label>
                                <input type="date" id="reportDate" class="form-control">
                                <button id="generateReportBtn" class="btn btn-primary">
                                    <i class="fas fa-search"></i> Generate Report
                                </button>
                            </div>
                        </div>
                        <!-- <div class="col-md-6">
                            <div class="info-box">
                                <h6><i class="fas fa-info-circle"></i> What this report shows:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check text-success"></i> Supervisor-wise summary for selected date</li>
                                    <li><i class="fas fa-check text-success"></i> Total feed allocated and vaccines used</li>
                                    <li><i class="fas fa-check text-success"></i> Batch visit statistics and percentages</li>
                                    <li><i class="fas fa-check text-success"></i> Only ongoing and closing batches are considered</li>
                                <li><i class="fas fa-info-circle text-info"></i> Closed batches are excluded from this report</li>
                                </ul>
                            </div>
                        </div> -->
                    </div>
                </div>
            </div>

            <!-- Supervisor Summary Table -->
            <div class="card" id="summaryCard" style="display: none;">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-table"></i> Supervisor Summary for <span id="selectedDate"></span>
                    </h5>
                    <div class="table-responsive">
                        <table class="table table-striped" id="supervisorSummaryTable">
                            <thead>
                                <tr>
                                    <th>Supervisor Name</th>
                                    <th>Feed Packets (50kg)</th>
                                    <th>Total Vaccines Used</th>
                                    <th>Batches Visited</th>
                                    <th>Total Batches Allocated</th>
                                    <th>Visit Percentage</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="supervisorSummaryBody">
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- Supervisor Details Modal -->
<div id="supervisorDetailsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-list"></i> Batch Details for <span id="supervisorName"></span></h2>
            <div class="export-actions">
                <button id="exportPngBtn" class="btn btn-sm" title="Export as image">Export PNG</button>
                <button id="exportPdfBtn" class="btn btn-sm" title="Export as PDF">Export PDF</button>
            </div>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <div class="details-info">
                <p><strong>Date:</strong> <span id="supervisorDate"></span></p>
                <p><strong>Total Batches:</strong> <span id="totalBatches"></span></p>
            </div>
            <div class="table-responsive">
                <table class="table table-striped details-flat" id="supervisorDetailsFlatTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Batch Number</th>
                            <th>Farm Name</th>
                            <th>Farm Batch #</th>
                            <th>Mortality</th>
                            <th>Feed Used (pkts)</th>
                            <th>Avg Wt (kg)</th>
                            <th>Male Wt (kg)</th>
                            <th>Female Wt (kg)</th>
                            <th>Feed Alloc (pkts)</th>
                            <th>Vaccines (units)</th>
                            <th>Medicines (units)</th>
                            <th>Health Mat (units)</th>
                            <th>Feeder Ret (pkts)</th>
                            <th>Feed Ret (pkts)</th>
                        </tr>
                    </thead>
                    <tbody id="supervisorDetailsFlatBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
.page-header {
    background: linear-gradient(135deg, #1a73e8, #1557b0);
    color: white;
    padding: 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    text-align: center;
}

.page-header h1 {
    margin: 0;
    font-size: 2.5rem;
    font-weight: 600;
}

.page-header p {
    margin: 0.5rem 0 0 0;
    opacity: 0.9;
    font-size: 1.1rem;
}

.card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
}

.card-body {
    padding: 2rem;
}

.card-title {
    color: #1a73e8;
    font-weight: 600;
    margin-bottom: 1rem;
}

.btn-lg {
    padding: 1rem 2rem;
    font-size: 1.1rem;
    border-radius: 8px;
}

.info-box {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    border-left: 4px solid #1a73e8;
}

.info-box h6 {
    color: #1a73e8;
    font-weight: 600;
    margin-bottom: 1rem;
}

.info-box ul li {
    margin-bottom: 0.5rem;
    color: #495057;
}

.info-box ul li i {
    margin-right: 0.5rem;
}

@media (max-width: 768px) {
    .page-header {
        padding: 1.5rem;
    }
    
    .page-header h1 {
        font-size: 2rem;
    }
    
    .card-body {
        padding: 1.5rem;
    }
    
    .btn-lg {
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
    }

    .date-filter-section {
        flex-direction: column;
        align-items: stretch;
    }

    .date-filter-section input[type="date"] {
        width: 100%;
        min-width: auto;
    }

    .date-filter-section .btn {
        margin-left: 0;
        margin-top: 1rem;
    }
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    animation: fadeIn 0.3s ease-out;
}

.modal-content {
    background-color: #fff;
    margin: 5% auto;
    padding: 0;
    border-radius: 12px;
    width: 90%;
    max-width: 1200px;
    max-height: 85vh;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    animation: slideDown 0.3s ease-out;
}

.modal-header {
    background: linear-gradient(135deg, #1a73e8, #1557b0);
    color: white;
    padding: 1.5rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 12px 12px 0 0;
}

.export-actions { display: flex; gap: 8px; align-items: center; }

.modal-header h2 {
    margin: 0;
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex: 1;
}

.export-actions .btn {
    background: #ffffff;
    color: #1557b0;
    border: none;
}

.export-actions .btn:hover {
    background: #e6eefc;
}

.close {
    color: white;
    font-size: 2rem;
    font-weight: bold;
    cursor: pointer;
    opacity: 0.8;
    transition: opacity 0.2s ease;
}

.close:hover {
    opacity: 1;
}

.modal-body {
    padding: 2rem;
    max-height: calc(85vh - 100px);
    overflow-y: auto;
}

/* Date Filter Section */
.date-filter-section {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
}

.date-filter-section label {
    font-weight: 600;
    color: #495057;
    margin: 0;
}

.date-filter-section input[type="date"] {
    padding: 0.5rem 1rem;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    font-size: 1rem;
    transition: border-color 0.2s ease;
    min-width: 150px;
}

.date-filter-section input[type="date"]:focus {
    border-color: #1a73e8;
    outline: none;
    box-shadow: 0 0 0 0.2rem rgba(26, 115, 232, 0.25);
}

.date-filter-section .btn {
    margin-left: auto;
}

/* Summary Section */
.summary-section h3 {
    color: #1a73e8;
    margin-bottom: 1.5rem;
    font-size: 1.25rem;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 0.5rem;
}

#summaryCard {
    margin-top: 2rem;
}

#summaryCard .card-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: #1a73e8;
    font-weight: 600;
    margin-bottom: 1.5rem;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 0.75rem;
}

#summaryCard .card-title i {
    font-size: 1.2em;
}

/* Table Styles */
.table-responsive {
    overflow-x: auto;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.table {
    width: 100%;
    margin-bottom: 0;
    background-color: white;
    border-collapse: collapse;
}

.table th {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    color: #495057;
    font-weight: 600;
    padding: 1rem;
    text-align: left;
    border-bottom: 2px solid #dee2e6;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.table td {
    padding: 1rem;
    border-bottom: 1px solid #e9ecef;
    vertical-align: middle;
}

.table tbody tr:hover {
    background-color: #f8f9fa;
    transition: background-color 0.2s ease;
}

.table tbody tr:last-child td {
    border-bottom: none;
}

/* Button Styles */
.btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 6px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-primary {
    background: linear-gradient(135deg, #1a73e8, #1557b0);
    color: white;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #1557b0, #0d47a1);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
}

.btn-info {
    background: linear-gradient(135deg, #17a2b8, #138496);
    color: white;
}

.btn-info:hover {
    background: linear-gradient(135deg, #138496, #117a8b);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
}

.btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.8rem;
}

/* Details Info */
.details-info {
    background: #e3f2fd;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    border-left: 4px solid #1a73e8;
}

.details-info p {
    margin: 0.5rem 0;
    color: #1565c0;
    font-weight: 500;
}

/* Badge Styles */
.badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 0.375rem;
    color: white;
}

.badge-success {
    background-color: #28a745;
}

.badge-warning {
    background-color: #ffc107;
    color: #212529;
}

.badge-danger {
    background-color: #dc3545;
}

/* Loading Spinner */
.fa-spin {
    animation: spin 1s linear infinite;
}

/* Form Control Focus */
.form-control:focus {
    border-color: #1a73e8;
    outline: none;
    box-shadow: 0 0 0 0.2rem rgba(26, 115, 232, 0.25);
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideDown {
    from {
        transform: translateY(-50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Responsive Design */
@media (max-width: 768px) {
    .modal-content {
        width: 95%;
        margin: 10% auto;
        max-height: 90vh;
    }

    .modal-header {
        padding: 1rem 1.5rem;
    }

    .modal-header h2 {
        font-size: 1.25rem;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .date-filter-section {
        flex-direction: column;
        align-items: stretch;
    }

    .date-filter-section input[type="date"] {
        width: 100%;
    }

    .table-responsive {
        font-size: 0.85rem;
    }

    .table th,
    .table td {
        padding: 0.75rem 0.5rem;
    }

    .update-title {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }

    .title-right {
        font-size: 0.8rem;
    }

    .section-subtitle {
        font-size: 0.9rem;
    }

    .details-table {
        font-size: 0.85rem;
    }

    .details-table th,
    .details-table td {
        padding: 0.5rem 0.75rem;
    }

    .summary-table {
        font-size: 0.8rem;
    }

    .summary-table th,
    .summary-table td {
        padding: 0.5rem 0.25rem;
    }

    .toggle-details {
        min-width: 80px;
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }

    .items-total {
        font-size: 1rem;
    }

    .items-breakdown small {
        font-size: 0.7rem;
    }
}

/* Additional Utility Styles */
.text-center {
    text-align: center;
}

.text-muted {
    color: #6c757d !important;
}

.text-info {
    color: #17a2b8 !important;
}

.table td.text-center {
    text-align: center;
}

.table td.text-muted {
    color: #6c757d;
    font-style: italic;
}

/* Update Section Styles */
.update-section {
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    overflow: hidden;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
}

.update-title {
    background: linear-gradient(135deg, #f8fafc, #e2e8f0);
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
}

.title-left {
    font-weight: 600;
    color: #1e293b;
}

.title-right {
    color: #64748b;
    font-size: 0.9rem;
}

.section-subtitle {
    color: #1e73e8;
    font-weight: 600;
    margin: 1.5rem 0 1rem 0;
    padding: 0.5rem 0;
    border-bottom: 2px solid #e9ecef;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.section-subtitle i {
    font-size: 1.1em;
}

.details-table {
    margin-bottom: 1.5rem;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.details-table th {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    color: #495057;
    font-weight: 600;
    padding: 0.75rem 1rem;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.details-table td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #f3f4f6;
    vertical-align: middle;
}

.details-table tbody tr:hover {
    background-color: #f8f9fa;
    transition: background-color 0.2s ease;
}

.details-table tbody tr:last-child td {
    border-bottom: none;
}

/* Summary Table Styles */
.summary-table-container {
    margin-bottom: 2rem;
}

.summary-table {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.summary-table th {
    background: linear-gradient(135deg, #1a73e8, #1557b0);
    color: white;
    font-weight: 600;
    padding: 1rem 0.75rem;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    text-align: center;
}

.summary-table td {
    padding: 0.75rem;
    border-bottom: 1px solid #e9ecef;
    vertical-align: middle;
    text-align: center;
}

.summary-table tbody tr:hover {
    background-color: #f8f9fa;
    transition: background-color 0.2s ease;
}

.summary-row {
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.summary-row:hover {
    background-color: #e3f2fd !important;
}

/* Details Section Styles */
.details-section {
    background: #f8f9fa;
}

.details-cell {
    padding: 0 !important;
    border: none !important;
}

.details-cell .update-section {
    margin: 0;
    border-radius: 0;
    border: none;
    box-shadow: none;
}

/* Toggle Button Styles */
.toggle-details {
    transition: all 0.2s ease;
    min-width: 100px;
}

.toggle-details:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.btn-outline-secondary {
    background: transparent;
    border-color: #6c757d;
    color: #6c757d;
}

.btn-outline-secondary:hover {
    background: #6c757d;
    border-color: #6c757d;
    color: white;
}

/* Items Breakdown Styles */
.items-total {
    font-weight: 600;
    font-size: 1.1rem;
    color: #1a73e8;
    display: block;
    margin-bottom: 0.25rem;
}

.items-breakdown {
    line-height: 1.2;
}

.items-breakdown small {
    font-size: 0.75rem;
    color: #6c757d;
}

.items-breakdown .text-muted {
    color: #6c757d !important;
}
.update-card { background: #fff; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 16px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.06); }
.update-card-header { padding: 16px 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
.update-card-header h4 { margin: 0; color: #1e293b; font-size: 1rem; }
.update-meta { color: #64748b; font-size: 0.85rem; margin-top: 4px; }
.update-card-body { padding: 16px 20px; }
.remarks-box { padding: 12px; background: #f1f5f9; border-left: 4px solid #4299e1; border-radius: 8px; margin: 12px 0; }
.remarks-title { font-weight: 600; color: #1f2937; margin-bottom: 6px; }
.remarks-content { color: #374151; white-space: pre-wrap; }
.priority.high { color: #dc2626; }
.priority.medium { color: #d97706; }
.priority.low { color: #059669; }
.item-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; }
.item-header { background: #f8fafc; padding: 10px 12px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; }
.item-name { font-weight: 600; color: #1e293b; }
.quantity-badge { background: #e2e8f0; color: #1f2937; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; }
.item-details { padding: 10px 12px; }
.detail-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f3f4f6; }
.detail-row:last-child { border-bottom: none; }
.category-section { margin-top: 16px; }
.category-section h5 { margin: 0 0 10px 0; color: #1e293b; font-size: 1rem; display: flex; align-items: center; gap: 8px; }
.items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 12px; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const supervisorDetailsModal = document.getElementById('supervisorDetailsModal');
    const closeButtons = document.querySelectorAll('.close');
    const generateReportBtn = document.getElementById('generateReportBtn');
    const reportDate = document.getElementById('reportDate');
    const summaryCard = document.getElementById('summaryCard');
    const selectedDateSpan = document.getElementById('selectedDate');

    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    reportDate.value = today;

    // Auto-generate report for today when page loads
    generateSupervisorReport(today);

    // Close modals
    closeButtons.forEach(button => {
        button.addEventListener('click', function() {
            supervisorDetailsModal.style.display = 'none';
        });
    });

    // Close modal when clicking outside
    window.addEventListener('click', function(e) {
        if (e.target === supervisorDetailsModal) {
            supervisorDetailsModal.style.display = 'none';
        }
    });

    // Generate report button
    generateReportBtn.addEventListener('click', function() {
        const selectedDate = reportDate.value;
        if (selectedDate) {
            generateSupervisorReport(selectedDate);
        }
    });

    // Generate supervisor report
    function generateSupervisorReport(date) {
        // Show loading state
        generateReportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
        generateReportBtn.disabled = true;

        // Update selected date display
        selectedDateSpan.textContent = new Date(date).toLocaleDateString();

        // Make API call to get supervisor report data
        fetch(`/api/supervisor-report?date=${date}`)
            .then(response => response.json())
            .then(data => {
                if (data.success === false) {
                    throw new Error(data.message || 'Failed to generate report');
                }
                displaySupervisorSummary(data);
                summaryCard.style.display = 'block';
                generateReportBtn.innerHTML = '<i class="fas fa-search"></i> Generate Report';
                generateReportBtn.disabled = false;
            })
            .catch(error => {
                console.error('Error generating report:', error);
                displaySupervisorSummary([]);
                summaryCard.style.display = 'block';
                generateReportBtn.innerHTML = '<i class="fas fa-search"></i> Generate Report';
                generateReportBtn.disabled = false;
            });
    }

    // Display supervisor summary
    function displaySupervisorSummary(data) {
        const tbody = document.getElementById('supervisorSummaryBody');
        tbody.innerHTML = '';

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No data available for the selected date</td></tr>';
            return;
        }

        data.forEach(supervisor => {
            const row = document.createElement('tr');
            const visitPercentage = supervisor.totalBatches ? ((supervisor.batchesVisited / supervisor.totalBatches) * 100).toFixed(1) : '0.0';
            
            row.innerHTML = `
                <td><strong>${supervisor.name}</strong></td>
                <td>${(supervisor.totalFeedAllocated / 50).toFixed(2)} packets</td>
                <td>${supervisor.totalVaccinesUsed}</td>
                <td>${supervisor.batchesVisited}</td>
                <td>${supervisor.totalBatches}</td>
                <td>
                    <span class="badge ${visitPercentage >= 80 ? 'badge-success' : visitPercentage >= 60 ? 'badge-warning' : 'badge-danger'}">
                        ${visitPercentage}%
                    </span>
                </td>
                <td>
                    <button class="btn btn-info btn-sm" onclick="viewSupervisorDetails(${supervisor.id}, '${supervisor.name}', '${reportDate.value}')">
                        <i class="fas fa-eye"></i> View Details
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    // View supervisor details
    window.viewSupervisorDetails = function(supervisorId, supervisorName, date) {
        const supervisorDetailsModal = document.getElementById('supervisorDetailsModal');
        const supervisorNameSpan = document.getElementById('supervisorName');
        const supervisorDateSpan = document.getElementById('supervisorDate');
        const totalBatchesSpan = document.getElementById('totalBatches');
        const modalBody = document.querySelector('.modal-body');

        supervisorNameSpan.textContent = supervisorName;
        supervisorDateSpan.textContent = new Date(date).toLocaleDateString();

        // Show modal immediately with a loading state
        if (modalBody) {
            modalBody.innerHTML = `
                <div class="details-info">
                    <p><strong>Date:</strong> <span id="supervisorDate">${new Date(date).toLocaleDateString()}</span></p>
                    <p><strong>Total Batches:</strong> <span id="totalBatches">Loading...</span></p>
                </div>
                <div class="text-center" style="padding: 1rem;">
                    <i class="fas fa-spinner fa-spin"></i> Loading details...
                </div>
            `;
        }
        supervisorDetailsModal.style.display = 'block';
        
        // Fetch supervisor details
        fetch(`/api/supervisor-details?supervisor_id=${supervisorId}&date=${date}`)
            .then(response => response.json())
            .then(data => {
                try {
                    if (data && data.success === false) {
                        throw new Error(data.message || 'Failed to fetch supervisor details');
                    }
                    displaySupervisorDetails(Array.isArray(data) ? data : []);
                    const refreshedTotal = document.getElementById('totalBatches');
                    if (refreshedTotal) refreshedTotal.textContent = Array.isArray(data) ? data.length : 0;
                } catch (err) {
                    console.error('Error rendering supervisor details:', err);
                    displaySupervisorDetails([]);
                    const refreshedTotal = document.getElementById('totalBatches');
                    if (refreshedTotal) refreshedTotal.textContent = 0;
                }
            })
            .catch(error => {
                console.error('Error fetching supervisor details:', error);
                try {
                    displaySupervisorDetails([]);
                } catch (_) {}
                totalBatchesSpan.textContent = 0;
            });
    };

    // Display supervisor details
    let lastSupervisorDetailsData = [];

    function displaySupervisorDetails(data) {
        const modalBody = document.querySelector('.modal-body');
        
        // Keep a copy for export
        lastSupervisorDetailsData = Array.isArray(data) ? data : [];
        
        // Clear previous sections from modal body (keep the details-info div if present)
        const existingDetailsInfo = modalBody.querySelector('.details-info');
        modalBody.innerHTML = '';
        if (existingDetailsInfo) {
            modalBody.appendChild(existingDetailsInfo);
        }

        if (!Array.isArray(data) || data.length === 0) {
            const emptyMsg = document.createElement('div');
            emptyMsg.className = 'text-center text-muted';
            emptyMsg.style.padding = '1rem';
            emptyMsg.textContent = 'No batch updates found for this supervisor on the selected date';
            modalBody.appendChild(emptyMsg);
            return;
        }

        // Create summary table with expandable rows
        const summaryTable = document.createElement('div');
        summaryTable.className = 'summary-table-container';
        summaryTable.innerHTML = `
            <h6 class="section-subtitle"><i class="fas fa-table"></i> Batch Updates Summary</h6>
            <div class="table-responsive">
                <table class="table summary-table">
                    <thead>
                        <tr>
                            <th>Batch</th>
                            <th>Farm & Batch #</th>
                            <th>Time</th>
                            <th>Mortality</th>
                            <th>Feed Used (pkts)</th>
                            <th>Feed Alloc (pkts)</th>
                            <th>Items Used</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="summaryTableBody">
                    </tbody>
                </table>
            </div>
        `;
        modalBody.appendChild(summaryTable);

        data.forEach((update, index) => {
            // Create summary row
            const summaryRow = document.createElement('tr');
            summaryRow.className = 'summary-row';
            summaryRow.setAttribute('data-update-index', index);
            
            // Compute totals with robust numeric handling
            const feedAllocPkts = (update.feeds || []).reduce((sum, f) => sum + (parseFloat(f.quantity_packets) || 0), 0);
            const vaccinesUnits = (update.vaccines || []).reduce((sum, v) => sum + (parseFloat(v.quantity) || 0), 0);
            const medicinesUnits = (update.medicines || []).reduce((sum, m) => sum + (parseFloat(m.quantity) || 0), 0);
            const healthUnits = (update.health_materials || []).reduce((sum, h) => sum + (parseFloat(h.quantity) || 0), 0);
            const miscUnits = (update.misc_items || []).reduce((sum, mi) => sum + (parseFloat(mi.units_used) || 0), 0);

            // Combine farm name and farm batch number
            const farmDisplay = update.farmBatchNumber && update.farmBatchNumber !== 0 
                ? `${update.farmName} (${update.farmBatchNumber})`
                : update.farmName;
            
            // Calculate total items used
            const totalItemsUsed = vaccinesUnits + medicinesUnits + healthUnits + miscUnits;
            
            summaryRow.innerHTML = `
                <td><strong>${update.batchNumber}</strong></td>
                <td>${farmDisplay}</td>
                <td>${update.visitTime}</td>
                <td>${(update.basic && update.basic.mortality_count) || 0}</td>
                <td>${((update.basic && update.basic.feed_used_packets) || 0).toFixed(2)}</td>
                <td>${feedAllocPkts.toFixed(2)}</td>
                <td>
                    <span class="items-total">${totalItemsUsed.toFixed(2)}</span>
                    <div class="items-breakdown">
                        <small class="text-muted">
                            V: ${vaccinesUnits.toFixed(2)} | M: ${medicinesUnits.toFixed(2)} | H: ${healthUnits.toFixed(2)} | Misc: ${miscUnits.toFixed(2)}
                        </small>
                    </div>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary toggle-details" onclick="toggleUpdateDetails(${index})">
                        <i class="fas fa-chevron-down"></i> Details
                    </button>
                </td>
            `;
            
            document.getElementById('summaryTableBody').appendChild(summaryRow);

            // Create expandable details section
            const detailsSection = document.createElement('tr');
            detailsSection.className = 'details-section';
            detailsSection.id = `details-${index}`;
            detailsSection.style.display = 'none';
            
            const detailsCell = document.createElement('td');
            detailsCell.colSpan = 8;
            detailsCell.className = 'details-cell';
            
            // Create the detailed content
            const section = document.createElement('div');
            section.className = 'update-section';

            // Header
            const headerHtml = `
                <div class="update-title">
                    <div class="title-left">
                        <strong>Batch ${update.batchNumber}</strong> - ${update.farmName}
                    </div>
                    <div class="title-right">${update.date} &nbsp;|&nbsp; ${update.visitTime}</div>
                </div>
            `;

            // Basic Info Table
            const basicRows = [
                ['Mortality', update.basic.mortality_count],
                ['Feed Used (packets)', update.basic.feed_used_packets.toFixed(2)],
                ['Avg Weight (kg)', update.basic.avg_weight_kg.toFixed(2)],
                ['Male Weight (kg)', update.basic.male_weight_kg.toFixed(2)],
                ['Female Weight (kg)', update.basic.female_weight_kg.toFixed(2)],
            ];
            if (update.basic.remarks && update.basic.remarks.trim() !== '') {
                basicRows.push(['Remarks' + (update.basic.remarks_priority ? ` (${update.basic.remarks_priority})` : ''), update.basic.remarks]);
            }
            const basicTable = `
                <h6 class="section-subtitle"><i class="fas fa-info-circle"></i> Basic Information</h6>
                <table class="table details-table">
                    <thead><tr><th style="width: 40%">Field</th><th>Value</th></tr></thead>
                    <tbody>
                        ${basicRows.map(r => `<tr><td>${r[0]}</td><td>${r[1]}</td></tr>`).join('')}
                    </tbody>
                </table>
            `;

            // Feeds Table
            const feedsTable = (update.feeds && update.feeds.length) ? `
                <h6 class="section-subtitle"><i class="fas fa-seedling"></i> Feed Allocations</h6>
                <table class="table details-table">
                    <thead><tr>
                        <th>Brand</th><th>Category</th><th>Packets</th><th>Qty/Unit (kg)</th><th>Price</th><th>Total Cost</th>
                    </tr></thead>
                    <tbody>
                        ${update.feeds.map(f => `
                            <tr>
                                <td>${f.brand}</td>
                                <td>${f.category}</td>
                                <td>${f.quantity_packets.toFixed(2)}</td>
                                <td>${f.quantity_per_unit_kg.toFixed(2)}</td>
                                <td>₹${f.price_at_time.toFixed(2)}</td>
                                <td>₹${f.total_cost.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '';

            // Medicines Table
            const medicinesTable = (update.medicines && update.medicines.length) ? `
                <h6 class="section-subtitle"><i class="fas fa-pills"></i> Medicines</h6>
                <table class="table details-table">
                    <thead><tr>
                        <th>Name</th><th>Quantity</th><th>Qty/Unit</th><th>Unit</th><th>Price</th><th>Total Cost</th><th>Scheduled</th>
                    </tr></thead>
                    <tbody>
                        ${update.medicines.map(m => `
                            <tr>
                                <td>${m.name}</td>
                                <td>${m.quantity.toFixed(2)}</td>
                                <td>${m.quantity_per_unit.toFixed(2)}</td>
                                <td>${m.unit_type}</td>
                                <td>₹${m.price_at_time.toFixed(2)}</td>
                                <td>₹${m.total_cost.toFixed(2)}</td>
                                <td>${m.scheduled ? 'Yes' : 'No'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '';

            // Health Materials Table
            const healthTable = (update.health_materials && update.health_materials.length) ? `
                <h6 class="section-subtitle"><i class="fas fa-medkit"></i> Health Materials</h6>
                <table class="table details-table">
                    <thead><tr>
                        <th>Name</th><th>Quantity</th><th>Qty/Unit</th><th>Unit</th><th>Price</th><th>Total Cost</th>
                    </tr></thead>
                    <tbody>
                        ${update.health_materials.map(h => `
                            <tr>
                                <td>${h.name}</td>
                                <td>${h.quantity.toFixed(2)}</td>
                                <td>${h.quantity_per_unit.toFixed(2)}</td>
                                <td>${h.unit_type}</td>
                                <td>₹${h.price_at_time.toFixed(2)}</td>
                                <td>₹${h.total_cost.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '';

            // Vaccines Table
            const vaccinesTable = (update.vaccines && update.vaccines.length) ? `
                <h6 class="section-subtitle"><i class="fas fa-syringe"></i> Vaccines</h6>
                <table class="table details-table">
                    <thead><tr>
                        <th>Name</th><th>Quantity</th><th>Qty/Unit</th><th>Unit</th><th>Dose</th><th>Price</th><th>Total Cost</th><th>Scheduled</th>
                    </tr></thead>
                    <tbody>
                        ${update.vaccines.map(v => `
                            <tr>
                                <td>${v.name}</td>
                                <td>${v.quantity.toFixed(2)}</td>
                                <td>${v.quantity_per_unit.toFixed(2)}</td>
                                <td>${v.unit_type}</td>
                                <td>${v.dose_number ?? ''}</td>
                                <td>₹${v.price_at_time.toFixed(2)}</td>
                                <td>₹${v.total_cost.toFixed(2)}</td>
                                <td>${v.scheduled ? 'Yes' : 'No'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '';

            // Misc Items Table
            const miscTable = (update.misc_items && update.misc_items.length) ? `
                <h6 class="section-subtitle"><i class="fas fa-tools"></i> Miscellaneous Items</h6>
                <table class="table details-table">
                    <thead><tr>
                        <th>Name</th><th>Units Used</th><th>Qty/Unit</th><th>Unit</th><th>Price</th><th>Total Cost</th>
                    </tr></thead>
                    <tbody>
                        ${update.misc_items.map(mi => `
                            <tr>
                                <td>${mi.name}</td>
                                <td>${mi.units_used.toFixed(2)}</td>
                                <td>${mi.quantity_per_unit.toFixed(2)}</td>
                                <td>${mi.unit_type}</td>
                                <td>₹${mi.price_per_unit.toFixed(2)}</td>
                                <td>₹${mi.total_cost.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '';

            // Returns Table
            const returnsTable = (((update.feed_returns && update.feed_returns.length) || 0) || ((update.feeder_returns && update.feeder_returns.length) || 0)) ? `
                <h6 class="section-subtitle"><i class="fas fa-undo"></i> Returns</h6>
                <table class="table details-table">
                    <thead><tr>
                        <th>Type</th><th>Feed</th><th>Quantity (packets)</th>
                    </tr></thead>
                    <tbody>
                        ${(update.feeder_returns || []).map(r => `
                            <tr><td>Feeder Return</td><td>${r.feed_name}</td><td>-${r.quantity_packets.toFixed(2)}</td></tr>
                        `).join('')}
                        ${(update.feed_returns || []).map(r => `
                            <tr><td>Feed Stock Return</td><td>${r.feed_name}</td><td>+${r.quantity_packets.toFixed(2)}</td></tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '';

            // Combine all tables into the section
            section.innerHTML = `
                ${headerHtml}
                ${basicTable}
                ${feedsTable}
                ${medicinesTable}
                ${healthTable}
                ${vaccinesTable}
                ${miscTable}
                ${returnsTable}
            `;

            detailsCell.appendChild(section);
            detailsSection.appendChild(detailsCell);
            
            // Insert details section after the summary row
            summaryRow.parentNode.insertBefore(detailsSection, summaryRow.nextSibling);
        });

        supervisorDetailsModal.style.display = 'block';
    }

    // Toggle update details
    window.toggleUpdateDetails = function(index) {
        const detailsSection = document.getElementById(`details-${index}`);
        let button = (typeof event !== 'undefined' && event && event.target) ? event.target.closest('.toggle-details') : null;
        if (!button) {
            // Fallback: find the toggle button in the previous summary row
            const summaryRow = document.getElementById(`details-${index}`)?.previousSibling;
            button = summaryRow ? summaryRow.querySelector('.toggle-details') : null;
        }
        const icon = button ? button.querySelector('i') : null;
        
        if (detailsSection.style.display === 'none') {
            detailsSection.style.display = 'table-row';
            if (icon) icon.className = 'fas fa-chevron-up';
            if (button) {
                button.innerHTML = '<i class="fas fa-chevron-up"></i> Hide Details';
                button.classList.remove('btn-outline-primary');
                button.classList.add('btn-outline-secondary');
            }
        } else {
            detailsSection.style.display = 'none';
            if (icon) icon.className = 'fas fa-chevron-down';
            if (button) {
                button.innerHTML = '<i class="fas fa-chevron-down"></i> Details';
                button.classList.remove('btn-outline-secondary');
                button.classList.add('btn-outline-primary');
            }
        }
    };

    // Remove sample data; rely on API only
    // Build export tables from lastSupervisorDetailsData
    function buildExportHtml(supervisorName, reportDateStr) {
        const data = Array.isArray(lastSupervisorDetailsData) ? lastSupervisorDetailsData : [];

        // Daily info table rows
        const dailyRows = data.map(u => {
            const feedAllocPkts = (u.feeds || []).reduce((sum, f) => sum + (parseFloat(f.quantity_packets) || 0), 0);

            // Per-category items used, show only updated, with units
            const vTotal = (u.vaccines || []).reduce((s, v) => s + (parseFloat(v.quantity) || 0), 0);
            const mTotal = (u.medicines || []).reduce((s, m) => s + (parseFloat(m.quantity) || 0), 0);
            const hTotal = (u.health_materials || []).reduce((s, h) => s + (parseFloat(h.quantity) || 0), 0);
            const miscTotal = (u.misc_items || []).reduce((s, mi) => s + (parseFloat(mi.units_used) || 0), 0);

            // Determine preferred units per category from first item where available
            const vUnit = (u.vaccines && u.vaccines.find(v => v && v.unit_type)?.unit_type) || 'ml';
            const mUnit = (u.medicines && u.medicines.find(m => m && m.unit_type)?.unit_type) || '';
            const hUnit = (u.health_materials && u.health_materials.find(h => h && h.unit_type)?.unit_type) || '';
            const miscUnit = (u.misc_items && u.misc_items.find(mi => mi && mi.unit_type)?.unit_type) || '';

            const itemsLines = [];
            if (vTotal > 0) itemsLines.push(`<div>Vaccine: ${vTotal.toFixed(2)} ${vUnit}</div>`);
            if (mTotal > 0) itemsLines.push(`<div>Medicine: ${mTotal.toFixed(2)} ${mUnit}</div>`);
            if (hTotal > 0) itemsLines.push(`<div>Health Materials: ${hTotal.toFixed(2)} ${hUnit}</div>`);
            if (miscTotal > 0) itemsLines.push(`<div>Misc: ${miscTotal.toFixed(2)} ${miscUnit}</div>`);
            const itemsCell = itemsLines.length ? itemsLines.join('') : '<div class="text-muted">-</div>';

            return `
                <tr>
                    <td>${u.batchNumber || ''}</td>
                    <td>${u.farmName || ''}</td>
                    <td style="text-align:right">${((u.basic && u.basic.mortality_count) || 0)}</td>
                    <td style="text-align:right">${(((u.basic && u.basic.feed_used_packets) || 0).toFixed(2))}</td>
                    <td style="text-align:right">${feedAllocPkts.toFixed(2)}</td>
                    <td>${itemsCell}</td>
                </tr>`;
        }).join('');

        // Weight updates table rows (only for entries having avg/male/female weight > 0)
        const weightRows = data
            .filter(u => (u.basic && ((u.basic.avg_weight_kg||0) > 0 || (u.basic.male_weight_kg||0) > 0 || (u.basic.female_weight_kg||0) > 0)))
            .map(u => `
                <tr>
                    <td>${u.batchNumber || ''}</td>
                    <td>${u.farmName || ''}</td>
                    <td style="text-align:right">${(u.basic.avg_weight_kg||0).toFixed(2)}</td>
                    <td style="text-align:right">${(u.basic.male_weight_kg||0).toFixed(2)}</td>
                    <td style="text-align:right">${(u.basic.female_weight_kg||0).toFixed(2)}</td>
                </tr>`).join('');

        const hasWeight = weightRows.length > 0;

        // Minimal print styles for export clarity
        const styles = `
            <style>
                .export-wrap { font-family: Arial, sans-serif; color: #111827; }
                .export-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
                .export-title { font-size: 18px; font-weight: 700; }
                .export-meta { font-size: 12px; color:#6b7280; }
                table { width:100%; border-collapse: collapse; margin-top: 8px; }
                th, td { border: 1px solid #e5e7eb; padding: 6px 8px; font-size: 12px; }
                th { background: #f3f4f6; text-align: left; }
                .section { margin-top: 16px; }
            </style>`;

        return `
            <div class="export-wrap">
                ${styles}
                <div class="export-header">
                    <div class="export-title">Supervisor Daily Report</div>
                    <div class="export-meta">Supervisor: ${supervisorName || ''} | Date: ${reportDateStr || ''}</div>
                </div>

                <div class="section">
                    <div style="font-weight:600; margin-bottom:6px;">Daily Info</div>
                    <table>
                        <thead>
                            <tr>
                                <th>Batch</th>
                                <th>Farm</th>
                                <th>Mortality</th>
                                <th>Feed Used (pkts)</th>
                                <th>Feed Alloc (pkts)</th>
                                <th>Items Used</th>
                            </tr>
                        </thead>
                        <tbody>${dailyRows || ''}</tbody>
                    </table>
                </div>
                ${hasWeight ? `
                <div class="section">
                    <div style="font-weight:600; margin-bottom:6px;">Weight Updates</div>
                    <table>
                        <thead>
                            <tr>
                                <th>Batch</th>
                                <th>Farm</th>
                                <th>Avg Wt (kg)</th>
                                <th>Male Wt (kg)</th>
                                <th>Female Wt (kg)</th>
                            </tr>
                        </thead>
                        <tbody>${weightRows}</tbody>
                    </table>
                </div>` : ''}
            </div>
        `;
    }

    /* function getSampleData() {
        return [
            {
                name: "John Smith",
                totalFeedAllocated: 150,
                totalVaccinesUsed: 25,
                batchesVisited: 8,
                totalBatches: 10
            },
            {
                name: "Sarah Johnson",
                totalFeedAllocated: 120,
                totalVaccinesUsed: 20,
                batchesVisited: 7,
                totalBatches: 8
            },
            {
                name: "Mike Wilson",
                totalFeedAllocated: 180,
                totalVaccinesUsed: 30,
                batchesVisited: 9,
                totalBatches: 12
            }
        ];
    } */

    /* function getSampleDetailsData(supervisorName) {
        return [
            {
                batchNumber: "B001",
                farmName: "North Farm",
                feedAllocated: 25,
                vaccinesUsed: 5,
                visitTime: "09:00 AM"
            },
            {
                batchNumber: "B002",
                farmName: "South Farm",
                feedAllocated: 30,
                vaccinesUsed: 8,
                visitTime: "10:30 AM"
            },
            {
                batchNumber: "B003",
                farmName: "East Farm",
                feedAllocated: 20,
                vaccinesUsed: 3,
                visitTime: "02:15 PM"
            }
        ];
    }
    */
    // Export handlers
    function wireExportButtons() {
        const pngBtn = document.getElementById('exportPngBtn');
        const pdfBtn = document.getElementById('exportPdfBtn');
        const supervisor = document.getElementById('supervisorName')?.textContent || '';
        const dateText = document.getElementById('supervisorDate')?.textContent || '';

        if (!pngBtn || !pdfBtn) return;

        pngBtn.onclick = async function() {
            try {
                const html = buildExportHtml(supervisor, dateText);
                const container = document.createElement('div');
                container.style.position = 'fixed';
                container.style.left = '-99999px';
                container.style.top = '0';
                container.style.background = '#ffffff';
                container.style.padding = '24px';
                container.style.boxSizing = 'border-box';
                container.innerHTML = html;
                document.body.appendChild(container);

                const canvas = await html2canvas(container, { scale: 2, backgroundColor: '#ffffff' });
                const dataUrl = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = dataUrl;
                a.download = `Supervisor_Report_${supervisor}_${dateText}.png`;
                a.click();
                document.body.removeChild(container);
            } catch (e) {
                console.error('PNG export failed', e);
                alert('Failed to export PNG');
            }
        };

        pdfBtn.onclick = async function() {
            try {
                const html = buildExportHtml(supervisor, dateText);
                const container = document.createElement('div');
                container.style.position = 'fixed';
                container.style.left = '-99999px';
                container.style.top = '0';
                container.style.width = '800px';
                container.innerHTML = html;
                document.body.appendChild(container);

                const canvas = await html2canvas(container, { scale: 2 });
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jspdf.jsPDF('p', 'pt', 'a4');

                // Fit image width to page, keep aspect ratio
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const imgWidth = pageWidth - 40; // 20pt margins
                const imgHeight = canvas.height * imgWidth / canvas.width;

                let y = 20;
                let x = 20;
                if (imgHeight < pageHeight - 40) {
                    pdf.addImage(imgData, 'PNG', x, y, imgWidth, imgHeight);
                } else {
                    // Multi-page if needed
                    let heightLeft = imgHeight;
                    let position = y;
                    pdf.addImage(imgData, 'PNG', x, position, imgWidth, imgHeight);
                    heightLeft -= (pageHeight - 40);
                    while (heightLeft > 0) {
                        pdf.addPage();
                        position = 20 - heightLeft;
                        pdf.addImage(imgData, 'PNG', x, position, imgWidth, imgHeight);
                        heightLeft -= (pageHeight - 40);
                    }
                }

                pdf.save(`Supervisor_Report_${supervisor}_${dateText}.pdf`);
                document.body.removeChild(container);
            } catch (e) {
                console.error('PDF export failed', e);
                alert('Failed to export PDF');
            }
        };
    }

    // Load export libs and wire buttons after first open
    function ensureExportLibs() {
        return new Promise((resolve, reject) => {
            const hasH2C = window.html2canvas;
            const hasJSPDF = window.jspdf || window.jsPDF || window.jspdf?.jsPDF;
            const tasks = [];
            if (!hasH2C) {
                const s = document.createElement('script');
                s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                s.onload = () => resolve();
                s.onerror = reject;
                document.body.appendChild(s);
                tasks.push(s);
            }
            if (!hasJSPDF) {
                const s2 = document.createElement('script');
                s2.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                s2.onload = () => resolve();
                s2.onerror = reject;
                document.body.appendChild(s2);
                tasks.push(s2);
            }
            if (hasH2C && hasJSPDF) resolve();
        });
    }

    // After modal is shown, ensure libs and wire
    const modalEl = document.getElementById('supervisorDetailsModal');
    const observer = new MutationObserver(() => {
        if (modalEl && modalEl.style.display === 'block') {
            ensureExportLibs().then(() => wireExportButtons());
        }
    });
    if (modalEl) {
        observer.observe(modalEl, { attributes: true, attributeFilter: ['style'] });
    }
});
</script>
{% endblock %} 