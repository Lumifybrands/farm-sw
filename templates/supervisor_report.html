{% extends "base.html" %}

{% block title %}Supervisor Report{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-header">
                <h1><i class="fas fa-user-check"></i> Supervisor Report</h1>
                <p class="text-muted">Monitor supervisor activities and batch updates by date</p>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="card-title">Generate Report</h5>
                            <p class="card-text">Select a date and generate the supervisor report for ongoing and closing batches.</p>
                            <div class="date-filter-section">
                                <label for="reportDate">Select Date:</label>
                                <input type="date" id="reportDate" class="form-control">
                                <button id="generateReportBtn" class="btn btn-primary">
                                    <i class="fas fa-search"></i> Generate Report
                                </button>
                            </div>
                        </div>
                        <!-- <div class="col-md-6">
                            <div class="info-box">
                                <h6><i class="fas fa-info-circle"></i> What this report shows:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check text-success"></i> Supervisor-wise summary for selected date</li>
                                    <li><i class="fas fa-check text-success"></i> Total feed allocated and vaccines used</li>
                                    <li><i class="fas fa-check text-success"></i> Batch visit statistics and percentages</li>
                                    <li><i class="fas fa-check text-success"></i> Only ongoing and closing batches are considered</li>
                                <li><i class="fas fa-info-circle text-info"></i> Closed batches are excluded from this report</li>
                                </ul>
                            </div>
                        </div> -->
                    </div>
                </div>
            </div>

            <!-- Supervisor Summary Table -->
            <div class="card" id="summaryCard" style="display: none;">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-table"></i> Supervisor Summary for <span id="selectedDate"></span>
                    </h5>
                    <div class="table-responsive">
                        <table class="table table-striped" id="supervisorSummaryTable">
                            <thead>
                                <tr>
                                    <th>Supervisor Name</th>
                                    <th>Feed Packets (50kg)</th>
                                    <th>Total Vaccines Used</th>
                                    <th>Batches Visited</th>
                                    <th>Total Batches Allocated</th>
                                    <th>Visit Percentage</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="supervisorSummaryBody">
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- Supervisor Details Modal -->
<div id="supervisorDetailsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-list"></i> Batch Details for <span id="supervisorName"></span></h2>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <div class="details-info">
                <p><strong>Date:</strong> <span id="supervisorDate"></span></p>
                <p><strong>Total Batches:</strong> <span id="totalBatches"></span></p>
            </div>
            <div class="table-responsive">
                <table class="table table-striped details-flat" id="supervisorDetailsFlatTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Batch Number</th>
                            <th>Farm Name</th>
                            <th>Farm Batch #</th>
                            <th>Mortality</th>
                            <th>Feed Used (pkts)</th>
                            <th>Avg Wt (kg)</th>
                            <th>Male Wt (kg)</th>
                            <th>Female Wt (kg)</th>
                            <th>Feed Alloc (pkts)</th>
                            <th>Vaccines (units)</th>
                            <th>Medicines (units)</th>
                            <th>Health Mat (units)</th>
                            <th>Feeder Ret (pkts)</th>
                            <th>Feed Ret (pkts)</th>
                        </tr>
                    </thead>
                    <tbody id="supervisorDetailsFlatBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
.page-header {
    background: linear-gradient(135deg, #1a73e8, #1557b0);
    color: white;
    padding: 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    text-align: center;
}

.page-header h1 {
    margin: 0;
    font-size: 2.5rem;
    font-weight: 600;
}

.page-header p {
    margin: 0.5rem 0 0 0;
    opacity: 0.9;
    font-size: 1.1rem;
}

.card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
}

.card-body {
    padding: 2rem;
}

.card-title {
    color: #1a73e8;
    font-weight: 600;
    margin-bottom: 1rem;
}

.btn-lg {
    padding: 1rem 2rem;
    font-size: 1.1rem;
    border-radius: 8px;
}

.info-box {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    border-left: 4px solid #1a73e8;
}

.info-box h6 {
    color: #1a73e8;
    font-weight: 600;
    margin-bottom: 1rem;
}

.info-box ul li {
    margin-bottom: 0.5rem;
    color: #495057;
}

.info-box ul li i {
    margin-right: 0.5rem;
}

@media (max-width: 768px) {
    .page-header {
        padding: 1.5rem;
    }
    
    .page-header h1 {
        font-size: 2rem;
    }
    
    .card-body {
        padding: 1.5rem;
    }
    
    .btn-lg {
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
    }

    .date-filter-section {
        flex-direction: column;
        align-items: stretch;
    }

    .date-filter-section input[type="date"] {
        width: 100%;
        min-width: auto;
    }

    .date-filter-section .btn {
        margin-left: 0;
        margin-top: 1rem;
    }
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    animation: fadeIn 0.3s ease-out;
}

.modal-content {
    background-color: #fff;
    margin: 5% auto;
    padding: 0;
    border-radius: 12px;
    width: 90%;
    max-width: 1200px;
    max-height: 85vh;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    animation: slideDown 0.3s ease-out;
}

.modal-header {
    background: linear-gradient(135deg, #1a73e8, #1557b0);
    color: white;
    padding: 1.5rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 12px 12px 0 0;
}

.modal-header h2 {
    margin: 0;
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.close {
    color: white;
    font-size: 2rem;
    font-weight: bold;
    cursor: pointer;
    opacity: 0.8;
    transition: opacity 0.2s ease;
}

.close:hover {
    opacity: 1;
}

.modal-body {
    padding: 2rem;
    max-height: calc(85vh - 100px);
    overflow-y: auto;
}

/* Date Filter Section */
.date-filter-section {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
}

.date-filter-section label {
    font-weight: 600;
    color: #495057;
    margin: 0;
}

.date-filter-section input[type="date"] {
    padding: 0.5rem 1rem;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    font-size: 1rem;
    transition: border-color 0.2s ease;
    min-width: 150px;
}

.date-filter-section input[type="date"]:focus {
    border-color: #1a73e8;
    outline: none;
    box-shadow: 0 0 0 0.2rem rgba(26, 115, 232, 0.25);
}

.date-filter-section .btn {
    margin-left: auto;
}

/* Summary Section */
.summary-section h3 {
    color: #1a73e8;
    margin-bottom: 1.5rem;
    font-size: 1.25rem;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 0.5rem;
}

#summaryCard {
    margin-top: 2rem;
}

#summaryCard .card-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: #1a73e8;
    font-weight: 600;
    margin-bottom: 1.5rem;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 0.75rem;
}

#summaryCard .card-title i {
    font-size: 1.2em;
}

/* Table Styles */
.table-responsive {
    overflow-x: auto;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.table {
    width: 100%;
    margin-bottom: 0;
    background-color: white;
    border-collapse: collapse;
}

.table th {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    color: #495057;
    font-weight: 600;
    padding: 1rem;
    text-align: left;
    border-bottom: 2px solid #dee2e6;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.table td {
    padding: 1rem;
    border-bottom: 1px solid #e9ecef;
    vertical-align: middle;
}

.table tbody tr:hover {
    background-color: #f8f9fa;
    transition: background-color 0.2s ease;
}

.table tbody tr:last-child td {
    border-bottom: none;
}

/* Button Styles */
.btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 6px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-primary {
    background: linear-gradient(135deg, #1a73e8, #1557b0);
    color: white;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #1557b0, #0d47a1);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
}

.btn-info {
    background: linear-gradient(135deg, #17a2b8, #138496);
    color: white;
}

.btn-info:hover {
    background: linear-gradient(135deg, #138496, #117a8b);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
}

.btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.8rem;
}

/* Details Info */
.details-info {
    background: #e3f2fd;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    border-left: 4px solid #1a73e8;
}

.details-info p {
    margin: 0.5rem 0;
    color: #1565c0;
    font-weight: 500;
}

/* Badge Styles */
.badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 0.375rem;
    color: white;
}

.badge-success {
    background-color: #28a745;
}

.badge-warning {
    background-color: #ffc107;
    color: #212529;
}

.badge-danger {
    background-color: #dc3545;
}

/* Loading Spinner */
.fa-spin {
    animation: spin 1s linear infinite;
}

/* Form Control Focus */
.form-control:focus {
    border-color: #1a73e8;
    outline: none;
    box-shadow: 0 0 0 0.2rem rgba(26, 115, 232, 0.25);
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideDown {
    from {
        transform: translateY(-50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Responsive Design */
@media (max-width: 768px) {
    .modal-content {
        width: 95%;
        margin: 10% auto;
        max-height: 90vh;
    }

    .modal-header {
        padding: 1rem 1.5rem;
    }

    .modal-header h2 {
        font-size: 1.25rem;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .date-filter-section {
        flex-direction: column;
        align-items: stretch;
    }

    .date-filter-section input[type="date"] {
        width: 100%;
    }

    .table-responsive {
        font-size: 0.85rem;
    }

    .table th,
    .table td {
        padding: 0.75rem 0.5rem;
    }
}

/* Additional Utility Styles */
.text-center {
    text-align: center;
}

.text-muted {
    color: #6c757d !important;
}

.text-info {
    color: #17a2b8 !important;
}

.table td.text-center {
    text-align: center;
}

.table td.text-muted {
    color: #6c757d;
    font-style: italic;
}
.update-card { background: #fff; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 16px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.06); }
.update-card-header { padding: 16px 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
.update-card-header h4 { margin: 0; color: #1e293b; font-size: 1rem; }
.update-meta { color: #64748b; font-size: 0.85rem; margin-top: 4px; }
.update-card-body { padding: 16px 20px; }
.remarks-box { padding: 12px; background: #f1f5f9; border-left: 4px solid #4299e1; border-radius: 8px; margin: 12px 0; }
.remarks-title { font-weight: 600; color: #1f2937; margin-bottom: 6px; }
.remarks-content { color: #374151; white-space: pre-wrap; }
.priority.high { color: #dc2626; }
.priority.medium { color: #d97706; }
.priority.low { color: #059669; }
.item-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; }
.item-header { background: #f8fafc; padding: 10px 12px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; }
.item-name { font-weight: 600; color: #1e293b; }
.quantity-badge { background: #e2e8f0; color: #1f2937; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; }
.item-details { padding: 10px 12px; }
.detail-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f3f4f6; }
.detail-row:last-child { border-bottom: none; }
.category-section { margin-top: 16px; }
.category-section h5 { margin: 0 0 10px 0; color: #1e293b; font-size: 1rem; display: flex; align-items: center; gap: 8px; }
.items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 12px; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const supervisorDetailsModal = document.getElementById('supervisorDetailsModal');
    const closeButtons = document.querySelectorAll('.close');
    const generateReportBtn = document.getElementById('generateReportBtn');
    const reportDate = document.getElementById('reportDate');
    const summaryCard = document.getElementById('summaryCard');
    const selectedDateSpan = document.getElementById('selectedDate');

    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    reportDate.value = today;

    // Auto-generate report for today when page loads
    generateSupervisorReport(today);

    // Close modals
    closeButtons.forEach(button => {
        button.addEventListener('click', function() {
            supervisorDetailsModal.style.display = 'none';
        });
    });

    // Close modal when clicking outside
    window.addEventListener('click', function(e) {
        if (e.target === supervisorDetailsModal) {
            supervisorDetailsModal.style.display = 'none';
        }
    });

    // Generate report button
    generateReportBtn.addEventListener('click', function() {
        const selectedDate = reportDate.value;
        if (selectedDate) {
            generateSupervisorReport(selectedDate);
        }
    });

    // Generate supervisor report
    function generateSupervisorReport(date) {
        // Show loading state
        generateReportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
        generateReportBtn.disabled = true;

        // Update selected date display
        selectedDateSpan.textContent = new Date(date).toLocaleDateString();

        // Make API call to get supervisor report data
        fetch(`/api/supervisor-report?date=${date}`)
            .then(response => response.json())
            .then(data => {
                if (data.success === false) {
                    throw new Error(data.message || 'Failed to generate report');
                }
                displaySupervisorSummary(data);
                summaryCard.style.display = 'block';
                generateReportBtn.innerHTML = '<i class="fas fa-search"></i> Generate Report';
                generateReportBtn.disabled = false;
            })
            .catch(error => {
                console.error('Error generating report:', error);
                displaySupervisorSummary([]);
                summaryCard.style.display = 'block';
                generateReportBtn.innerHTML = '<i class="fas fa-search"></i> Generate Report';
                generateReportBtn.disabled = false;
            });
    }

    // Display supervisor summary
    function displaySupervisorSummary(data) {
        const tbody = document.getElementById('supervisorSummaryBody');
        tbody.innerHTML = '';

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No data available for the selected date</td></tr>';
            return;
        }

        data.forEach(supervisor => {
            const row = document.createElement('tr');
            const visitPercentage = supervisor.totalBatches ? ((supervisor.batchesVisited / supervisor.totalBatches) * 100).toFixed(1) : '0.0';
            
            row.innerHTML = `
                <td><strong>${supervisor.name}</strong></td>
                <td>${(supervisor.totalFeedAllocated / 50).toFixed(2)} packets</td>
                <td>${supervisor.totalVaccinesUsed}</td>
                <td>${supervisor.batchesVisited}</td>
                <td>${supervisor.totalBatches}</td>
                <td>
                    <span class="badge ${visitPercentage >= 80 ? 'badge-success' : visitPercentage >= 60 ? 'badge-warning' : 'badge-danger'}">
                        ${visitPercentage}%
                    </span>
                </td>
                <td>
                    <button class="btn btn-info btn-sm" onclick="viewSupervisorDetails(${supervisor.id}, '${supervisor.name}', '${reportDate.value}')">
                        <i class="fas fa-eye"></i> View Details
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    // View supervisor details
    window.viewSupervisorDetails = function(supervisorId, supervisorName, date) {
        const supervisorDetailsModal = document.getElementById('supervisorDetailsModal');
        const supervisorNameSpan = document.getElementById('supervisorName');
        const supervisorDateSpan = document.getElementById('supervisorDate');
        const totalBatchesSpan = document.getElementById('totalBatches');

        supervisorNameSpan.textContent = supervisorName;
        supervisorDateSpan.textContent = new Date(date).toLocaleDateString();
        
        // Fetch supervisor details
        fetch(`/api/supervisor-details?supervisor_id=${supervisorId}&date=${date}`)
            .then(response => response.json())
            .then(data => {
                if (data.success === false) {
                    throw new Error(data.message || 'Failed to fetch supervisor details');
                }
                displaySupervisorDetails(data);
                totalBatchesSpan.textContent = data.length;
                supervisorDetailsModal.style.display = 'block';
            })
            .catch(error => {
                console.error('Error fetching supervisor details:', error);
                displaySupervisorDetails([]);
                totalBatchesSpan.textContent = 0;
                supervisorDetailsModal.style.display = 'block';
            });
    };

    // Display supervisor details
    function displaySupervisorDetails(data) {
        const tbody = document.getElementById('supervisorDetailsFlatBody');
        tbody.innerHTML = '';

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="15" class="text-center text-muted">No batch updates found for this supervisor on the selected date</td></tr>';
            return;
        }

        data.forEach(update => {
            const section = document.createElement('div');
            section.className = 'update-section';

            // Header
            const headerHtml = `
                <div class="update-title">
                    <div class="title-left">
                        <strong>Batch ${update.batchNumber}</strong> - ${update.farmName}
                    </div>
                    <div class="title-right">${update.date} &nbsp;|&nbsp; ${update.visitTime}</div>
                </div>
            `;

            // Basic Info Table
            const basicRows = [
                ['Mortality', update.basic.mortality_count],
                ['Feed Used (packets)', update.basic.feed_used_packets.toFixed(2)],
                ['Avg Weight (kg)', update.basic.avg_weight_kg.toFixed(2)],
                ['Male Weight (kg)', update.basic.male_weight_kg.toFixed(2)],
                ['Female Weight (kg)', update.basic.female_weight_kg.toFixed(2)],
            ];
            if (update.basic.remarks && update.basic.remarks.trim() !== '') {
                basicRows.push(['Remarks' + (update.basic.remarks_priority ? ` (${update.basic.remarks_priority})` : ''), update.basic.remarks]);
            }
            const basicTable = `
                <h6 class="section-subtitle"><i class="fas fa-info-circle"></i> Basic Information</h6>
                <table class="table details-table">
                    <thead><tr><th style="width: 40%">Field</th><th>Value</th></tr></thead>
                    <tbody>
                        ${basicRows.map(r => `<tr><td>${r[0]}</td><td>${r[1]}</td></tr>`).join('')}
                    </tbody>
                </table>
            `;

            // Feeds Table
            const feedsTable = (update.feeds && update.feeds.length) ? `
                <h6 class="section-subtitle"><i class="fas fa-seedling"></i> Feed Allocations</h6>
                <table class="table details-table">
                    <thead><tr>
                        <th>Brand</th><th>Category</th><th>Packets</th><th>Qty/Unit (kg)</th><th>Price</th><th>Total Cost</th>
                    </tr></thead>
                    <tbody>
                        ${update.feeds.map(f => `
                            <tr>
                                <td>${f.brand}</td>
                                <td>${f.category}</td>
                                <td>${f.quantity_packets.toFixed(2)}</td>
                                <td>${f.quantity_per_unit_kg.toFixed(2)}</td>
                                <td>₹${f.price_at_time.toFixed(2)}</td>
                                <td>₹${f.total_cost.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '';

            // Medicines Table
            const medicinesTable = (update.medicines && update.medicines.length) ? `
                <h6 class="section-subtitle"><i class="fas fa-pills"></i> Medicines</h6>
                <table class="table details-table">
                    <thead><tr>
                        <th>Name</th><th>Quantity</th><th>Qty/Unit</th><th>Unit</th><th>Price</th><th>Total Cost</th><th>Scheduled</th>
                    </tr></thead>
                    <tbody>
                        ${update.medicines.map(m => `
                            <tr>
                                <td>${m.name}</td>
                                <td>${m.quantity.toFixed(2)}</td>
                                <td>${m.quantity_per_unit.toFixed(2)}</td>
                                <td>${m.unit_type}</td>
                                <td>₹${m.price_at_time.toFixed(2)}</td>
                                <td>₹${m.total_cost.toFixed(2)}</td>
                                <td>${m.scheduled ? 'Yes' : 'No'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '';

            // Health Materials Table
            const healthTable = (update.health_materials && update.health_materials.length) ? `
                <h6 class="section-subtitle"><i class="fas fa-medkit"></i> Health Materials</h6>
                <table class="table details-table">
                    <thead><tr>
                        <th>Name</th><th>Quantity</th><th>Qty/Unit</th><th>Unit</th><th>Price</th><th>Total Cost</th>
                    </tr></thead>
                    <tbody>
                        ${update.health_materials.map(h => `
                            <tr>
                                <td>${h.name}</td>
                                <td>${h.quantity.toFixed(2)}</td>
                                <td>${h.quantity_per_unit.toFixed(2)}</td>
                                <td>${h.unit_type}</td>
                                <td>₹${h.price_at_time.toFixed(2)}</td>
                                <td>₹${h.total_cost.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '';

            // Vaccines Table
            const vaccinesTable = (update.vaccines && update.vaccines.length) ? `
                <h6 class="section-subtitle"><i class="fas fa-syringe"></i> Vaccines</h6>
                <table class="table details-table">
                    <thead><tr>
                        <th>Name</th><th>Quantity</th><th>Qty/Unit</th><th>Unit</th><th>Dose</th><th>Price</th><th>Total Cost</th><th>Scheduled</th>
                    </tr></thead>
                    <tbody>
                        ${update.vaccines.map(v => `
                            <tr>
                                <td>${v.name}</td>
                                <td>${v.quantity.toFixed(2)}</td>
                                <td>${v.quantity_per_unit.toFixed(2)}</td>
                                <td>${v.unit_type}</td>
                                <td>${v.dose_number ?? ''}</td>
                                <td>₹${v.price_at_time.toFixed(2)}</td>
                                <td>₹${v.total_cost.toFixed(2)}</td>
                                <td>${v.scheduled ? 'Yes' : 'No'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '';

            // Misc Items Table
            const miscTable = (update.misc_items && update.misc_items.length) ? `
                <h6 class="section-subtitle"><i class="fas fa-tools"></i> Miscellaneous</h6>
                <table class="table details-table">
                    <thead><tr>
                        <th>Name</th><th>Units Used</th><th>Qty/Unit</th><th>Unit</th><th>Price</th><th>Total Cost</th>
                    </tr></thead>
                    <tbody>
                        ${update.misc_items.map(mi => `
                            <tr>
                                <td>${mi.name}</td>
                                <td>${mi.units_used.toFixed(2)}</td>
                                <td>${mi.quantity_per_unit.toFixed(2)}</td>
                                <td>${mi.unit_type}</td>
                                <td>₹${mi.price_per_unit.toFixed(2)}</td>
                                <td>₹${mi.total_cost.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '';

            // Returns Table
            const returnsTable = ((update.feed_returns && update.feed_returns.length) || (update.feeder_returns && update.feeder_returns.length)) ? `
                <h6 class="section-subtitle"><i class="fas fa-undo"></i> Returns</h6>
                <table class="table details-table">
                    <thead><tr>
                        <th>Type</th><th>Feed</th><th>Quantity (packets)</th>
                    </tr></thead>
                    <tbody>
                        ${update.feeder_returns.map(r => `
                            <tr><td>Feeder Return</td><td>${r.feed_name}</td><td>-${r.quantity_packets.toFixed(2)}</td></tr>
                        `).join('')}
                        ${update.feed_returns.map(r => `
                            <tr><td>Feed Stock Return</td><td>${r.feed_name}</td><td>+${r.quantity_packets.toFixed(2)}</td></tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '';

            // Compute totals for row values
            const feedAllocPkts = (update.feeds || []).reduce((sum, f) => sum + (Number(f.quantity_packets) || 0), 0);
            const vaccinesUnits = (update.vaccines || []).reduce((sum, v) => sum + (Number(v.quantity) || 0), 0);
            const medicinesUnits = (update.medicines || []).reduce((sum, m) => sum + (Number(m.quantity) || 0), 0);
            const healthUnits = (update.health_materials || []).reduce((sum, h) => sum + (Number(h.quantity) || 0), 0);
            const feederRetPkts = (update.feeder_returns || []).reduce((sum, r) => sum + (Number(r.quantity_packets) || 0), 0);
            const feedRetPkts = (update.feed_returns || []).reduce((sum, r) => sum + (Number(r.quantity_packets) || 0), 0);

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${update.date}</td>
                <td>${update.batchNumber}</td>
                <td>${update.farmName}</td>
                <td>${update.farmBatchNumber && update.farmBatchNumber !== 0 ? update.farmBatchNumber : ''}</td>
                <td>${update.basic.mortality_count}</td>
                <td>${update.basic.feed_used_packets.toFixed(2)}</td>
                <td>${update.basic.avg_weight_kg.toFixed(2)}</td>
                <td>${update.basic.male_weight_kg.toFixed(2)}</td>
                <td>${update.basic.female_weight_kg.toFixed(2)}</td>
                <td>${feedAllocPkts.toFixed(2)}</td>
                <td>${vaccinesUnits.toFixed(2)}</td>
                <td>${medicinesUnits.toFixed(2)}</td>
                <td>${healthUnits.toFixed(2)}</td>
                <td>${feederRetPkts.toFixed(2)}</td>
                <td>${feedRetPkts.toFixed(2)}</td>
            `;
            tbody.appendChild(tr);
        });

        supervisorDetailsModal.style.display = 'block';
    }

    // Remove sample data; rely on API only
    /* function getSampleData() {
        return [
            {
                name: "John Smith",
                totalFeedAllocated: 150,
                totalVaccinesUsed: 25,
                batchesVisited: 8,
                totalBatches: 10
            },
            {
                name: "Sarah Johnson",
                totalFeedAllocated: 120,
                totalVaccinesUsed: 20,
                batchesVisited: 7,
                totalBatches: 8
            },
            {
                name: "Mike Wilson",
                totalFeedAllocated: 180,
                totalVaccinesUsed: 30,
                batchesVisited: 9,
                totalBatches: 12
            }
        ];
    } */

    /* function getSampleDetailsData(supervisorName) {
        return [
            {
                batchNumber: "B001",
                farmName: "North Farm",
                feedAllocated: 25,
                vaccinesUsed: 5,
                visitTime: "09:00 AM"
            },
            {
                batchNumber: "B002",
                farmName: "South Farm",
                feedAllocated: 30,
                vaccinesUsed: 8,
                visitTime: "10:30 AM"
            },
            {
                batchNumber: "B003",
                farmName: "East Farm",
                feedAllocated: 20,
                vaccinesUsed: 3,
                visitTime: "02:15 PM"
            }
        ];
    }
    */
});
</script>
{% endblock %} 